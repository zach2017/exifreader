version: "3.8"

# ─────────────────────────────────────────────────────
#  PDF & Image OCR Stack - LocalStack Community
#
#  Approach: bundle tesseract binaries directly in the
#  Lambda function zip (no Layer needed).
#  Binary builder runs on amazonlinux:2 for ABI compat
#  with the python3.9 Lambda runtime (also AL2).
# ─────────────────────────────────────────────────────

services:

  # 1. Build tesseract binaries on Amazon Linux 2
  layer-builder:
    image: amazonlinux:2
    container_name: ocr-layer-builder
    volumes:
      - ./layer-builder/build-layer.sh:/build-layer.sh:ro
      - layer-data:/out
    entrypoint: ["/bin/bash", "/build-layer.sh"]

  # 2. LocalStack
  localstack:
    image: localstack/localstack:latest
    container_name: ocr-localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=lambda,iam,logs
      - DEBUG=1
      - EAGER_SERVICE_LOADING=1
      - LAMBDA_DOCKER_NETWORK=ocr-net
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - localstack-data:/var/lib/localstack
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 10s
    depends_on:
      layer-builder:
        condition: service_completed_successfully
    networks:
      - ocr-net

  # 3. Deploy Lambda (merges binaries + handler into one zip)
  deployer:
    build: ./deployer
    container_name: ocr-deployer
    volumes:
      - layer-data:/layers:ro
      - ./lambda/handler.py:/src/handler.py:ro
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
    depends_on:
      localstack:
        condition: service_healthy
    networks:
      - ocr-net

  # 4. Flask backend
  backend:
    build: ./backend
    container_name: ocr-backend
    ports:
      - "5000:5000"
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
      - LOCALSTACK_ENDPOINT=http://localstack:4566
      - LAMBDA_FUNCTION_NAME=ocr-extract
    depends_on:
      deployer:
        condition: service_completed_successfully
    networks:
      - ocr-net

  # 5. Frontend
  frontend:
    build: ./frontend
    container_name: ocr-frontend
    ports:
      - "8080:80"
    depends_on:
      - backend
    networks:
      - ocr-net

volumes:
  localstack-data:
  layer-data:

networks:
  ocr-net:
    name: ocr-net
    driver: bridge
