<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Extract — Image to Text</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        display: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        surface: {
                            900: '#0a0a0f',
                            800: '#12121a',
                            700: '#1a1a26',
                            600: '#242436',
                        },
                        accent: {
                            DEFAULT: '#6ee7b7',
                            dim: '#34d399',
                            glow: 'rgba(110, 231, 183, 0.15)',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: #0a0a0f;
        }
        .grain-overlay {
            position: fixed; inset: 0; z-index: 0; opacity: 0.03; pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        }
        .drop-zone { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .drop-zone.dragover {
            border-color: #6ee7b7;
            background: rgba(110, 231, 183, 0.05);
            transform: scale(1.01);
        }
        .glow-border {
            box-shadow: 0 0 0 1px rgba(110, 231, 183, 0.1), 0 0 40px rgba(110, 231, 183, 0.03);
        }
        .glow-border:hover {
            box-shadow: 0 0 0 1px rgba(110, 231, 183, 0.2), 0 0 60px rgba(110, 231, 183, 0.06);
        }
        .result-card { animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) both; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 20px rgba(110, 231, 183, 0.1); } 50% { box-shadow: 0 0 40px rgba(110, 231, 183, 0.25); } }
        .processing { animation: pulse-glow 2s ease-in-out infinite; }
        .stat-pill {
            background: linear-gradient(135deg, rgba(110, 231, 183, 0.08), rgba(110, 231, 183, 0.03));
            border: 1px solid rgba(110, 231, 183, 0.12);
        }
        .text-output { scrollbar-width: thin; scrollbar-color: #34d399 transparent; }
        .text-output::-webkit-scrollbar { width: 4px; }
        .text-output::-webkit-scrollbar-track { background: transparent; }
        .text-output::-webkit-scrollbar-thumb { background: #34d399; border-radius: 2px; }
        .preview-image { max-height: 200px; object-fit: contain; }
        .scanning-line {
            position: absolute; left: 0; right: 0; height: 2px;
            background: linear-gradient(90deg, transparent, #6ee7b7, transparent);
            animation: scan 2s ease-in-out infinite;
        }
        @keyframes scan { 0% { top: 0; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
    </style>
</head>
<body class="min-h-screen text-gray-200 antialiased">
    <div class="grain-overlay"></div>

    <div class="relative z-10 max-w-3xl mx-auto px-6 py-16">
        <!-- Header -->
        <header class="mb-14 text-center">
            <div class="inline-flex items-center gap-2 px-3 py-1 mb-6 rounded-full text-xs font-mono text-accent border border-accent/20 bg-accent/5 tracking-wider uppercase">
                <span class="w-1.5 h-1.5 rounded-full bg-accent animate-pulse"></span>
                Lambda OCR Service
            </div>
            <h1 class="text-5xl font-display font-700 tracking-tight text-white mb-3">
                OCR <span class="text-accent">Extract</span>
            </h1>
            <p class="text-gray-500 font-light text-lg max-w-md mx-auto">
                Upload an image. A LocalStack Lambda function extracts every word.
            </p>
        </header>

        <!-- Upload Zone -->
        <div id="uploadSection" class="mb-8">
            <div id="dropZone" class="drop-zone glow-border relative rounded-2xl border border-dashed border-gray-700 bg-surface-800 p-12 text-center cursor-pointer transition-all duration-300 hover:border-gray-500">
                <input type="file" id="fileInput" accept="image/*" class="hidden">
                <div id="uploadPrompt">
                    <div class="mx-auto w-16 h-16 mb-5 rounded-2xl bg-surface-700 flex items-center justify-center">
                        <svg class="w-7 h-7 text-accent/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <p class="text-white font-medium mb-1.5">Drop image here or click to browse</p>
                    <p class="text-gray-500 text-sm">PNG, JPG, TIFF, BMP — up to 20MB</p>
                </div>
                <!-- Preview State -->
                <div id="previewState" class="hidden">
                    <div class="relative inline-block rounded-lg overflow-hidden mb-4">
                        <img id="previewImage" class="preview-image rounded-lg" alt="Preview">
                        <div id="scanLine" class="scanning-line hidden"></div>
                    </div>
                    <p id="fileName" class="text-white font-medium font-mono text-sm"></p>
                    <p id="fileSize" class="text-gray-500 text-xs mt-1"></p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div id="actionBar" class="hidden mt-4 flex gap-3">
                <button id="extractBtn" class="flex-1 py-3.5 px-6 rounded-xl bg-accent text-surface-900 font-semibold text-sm tracking-wide hover:bg-accent-dim transition-all duration-200 flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    Extract Text
                </button>
                <button id="clearBtn" class="py-3.5 px-5 rounded-xl border border-gray-700 text-gray-400 font-medium text-sm hover:border-gray-500 hover:text-gray-300 transition-all duration-200">
                    Clear
                </button>
            </div>
        </div>

        <!-- Processing Indicator -->
        <div id="processing" class="hidden mb-8">
            <div class="processing rounded-2xl bg-surface-800 border border-accent/20 p-8 text-center">
                <div class="inline-flex items-center gap-3">
                    <svg class="w-5 h-5 text-accent animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"/>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                    </svg>
                    <span class="text-accent font-mono text-sm tracking-wide">Running OCR via Lambda…</span>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="hidden">
            <div class="result-card rounded-2xl bg-surface-800 glow-border overflow-hidden">
                <div class="px-6 py-4 border-b border-white/5 flex flex-wrap gap-3">
                    <div class="stat-pill rounded-lg px-3.5 py-1.5 flex items-center gap-2">
                        <svg class="w-3.5 h-3.5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                        <span class="font-mono text-xs text-gray-300">Total: <span id="statTotalTime">—</span> ms</span>
                    </div>
                    <div class="stat-pill rounded-lg px-3.5 py-1.5 flex items-center gap-2">
                        <svg class="w-3.5 h-3.5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span class="font-mono text-xs text-gray-300">OCR: <span id="statOcrTime">—</span> ms</span>
                    </div>
                    <div class="stat-pill rounded-lg px-3.5 py-1.5 flex items-center gap-2">
                        <svg class="w-3.5 h-3.5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/></svg>
                        <span class="font-mono text-xs text-gray-300"><span id="statWords">—</span> words</span>
                    </div>
                    <div class="stat-pill rounded-lg px-3.5 py-1.5 flex items-center gap-2">
                        <svg class="w-3.5 h-3.5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        <span class="font-mono text-xs text-gray-300"><span id="statChars">—</span> chars</span>
                    </div>
                    <div class="stat-pill rounded-lg px-3.5 py-1.5 flex items-center gap-2">
                        <svg class="w-3.5 h-3.5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        <span class="font-mono text-xs text-gray-300" id="statFile">—</span>
                    </div>
                </div>
                <div class="p-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xs font-mono text-gray-500 tracking-widest uppercase">Extracted Text</h3>
                        <button id="copyBtn" class="text-xs font-mono text-accent/60 hover:text-accent transition-colors flex items-center gap-1.5">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                            Copy
                        </button>
                    </div>
                    <div id="extractedText" class="text-output font-mono text-sm text-gray-300 leading-relaxed bg-surface-900 rounded-xl p-5 max-h-80 overflow-y-auto whitespace-pre-wrap border border-white/5"></div>
                </div>
            </div>
        </div>

        <!-- Error -->
        <div id="errorBox" class="hidden mb-8">
            <div class="rounded-2xl bg-red-950/30 border border-red-500/20 p-6 text-center">
                <p class="text-red-400 font-mono text-sm" id="errorMessage"></p>
            </div>
        </div>

        <footer class="mt-16 text-center">
            <p class="text-gray-600 text-xs font-mono">Powered by LocalStack Lambda · Tesseract OCR · Docker Compose</p>
        </footer>
    </div>

    <script>
        // ===== DOM Elements =====
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const uploadPrompt = document.getElementById('uploadPrompt');
        const previewState = document.getElementById('previewState');
        const previewImage = document.getElementById('previewImage');
        const scanLine = document.getElementById('scanLine');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const actionBar = document.getElementById('actionBar');
        const extractBtn = document.getElementById('extractBtn');
        const clearBtn = document.getElementById('clearBtn');
        const processing = document.getElementById('processing');
        const results = document.getElementById('results');
        const errorBox = document.getElementById('errorBox');
        const errorMessage = document.getElementById('errorMessage');
        const extractedText = document.getElementById('extractedText');
        const copyBtn = document.getElementById('copyBtn');

        let selectedFile = null;
        let base64Data = null;

        // ===== File Handling =====
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) handleFile(file);
        });
        fileInput.addEventListener('change', (e) => { if (e.target.files[0]) handleFile(e.target.files[0]); });

        function handleFile(file) {
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                base64Data = e.target.result;
                previewImage.src = base64Data;
                fileName.textContent = file.name;
                fileSize.textContent = formatBytes(file.size);
                uploadPrompt.classList.add('hidden');
                previewState.classList.remove('hidden');
                actionBar.classList.remove('hidden');
                results.classList.add('hidden');
                errorBox.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        // ===== Clear =====
        clearBtn.addEventListener('click', () => {
            selectedFile = null; base64Data = null; fileInput.value = '';
            uploadPrompt.classList.remove('hidden');
            previewState.classList.add('hidden');
            actionBar.classList.add('hidden');
            results.classList.add('hidden');
            errorBox.classList.add('hidden');
        });

        // ===== Copy =====
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(extractedText.textContent).then(() => {
                copyBtn.innerHTML = '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Copied!';
                setTimeout(() => {
                    copyBtn.innerHTML = '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg> Copy';
                }, 2000);
            });
        });

        // ===== Lambda API Call =====
        /**
         * Calls the LocalStack Lambda OCR function via nginx reverse proxy.
         * Sends base64-encoded image data and receives extracted text + timing.
         *
         * @param {string} imageBase64 - Base64 data URL of the image
         * @param {string} filename - Original filename
         * @returns {Promise<Object>} - { text, processing_time_ms, word_count, text_length, filename }
         */
        async function callOcrLambda(imageBase64, filename) {
            const payload = { image: imageBase64, filename: filename };

            const response = await fetch('/api/ocr', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                const errText = await response.text();
                throw new Error('Lambda invocation failed (' + response.status + '): ' + errText);
            }

            const result = await response.json();
            if (result.error) throw new Error(result.error);
            return result;
        }

        // ===== Extract Button =====
        extractBtn.addEventListener('click', async () => {
            if (!base64Data || !selectedFile) return;

            extractBtn.disabled = true;
            extractBtn.classList.add('opacity-50', 'cursor-not-allowed');
            processing.classList.remove('hidden');
            results.classList.add('hidden');
            errorBox.classList.add('hidden');
            scanLine.classList.remove('hidden');

            try {
                const totalStart = performance.now();
                const data = await callOcrLambda(base64Data, selectedFile.name);
                const totalMs = (performance.now() - totalStart).toFixed(2);

                document.getElementById('statTotalTime').textContent = totalMs;
                document.getElementById('statOcrTime').textContent = data.processing_time_ms;
                document.getElementById('statWords').textContent = data.word_count;
                document.getElementById('statChars').textContent = data.text_length;
                document.getElementById('statFile').textContent = data.filename;
                extractedText.textContent = data.text || '(No text detected)';
                results.classList.remove('hidden');
            } catch (err) {
                errorMessage.textContent = err.message;
                errorBox.classList.remove('hidden');
            } finally {
                extractBtn.disabled = false;
                extractBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                processing.classList.add('hidden');
                scanLine.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
